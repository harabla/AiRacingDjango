<!-- telemetry.html -->
{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telemetry Data</title>
    <script src="{% static 'js/chart.umd.js' %}"></script>
</head>
<body>
    <canvas id="lapTimeChart"></canvas>
    <div id="lapTimeData" style="display:none;" data-lap-times="{{ lap_times|to_json }}"></div>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('{{ lap_times|escapejs }}');
        const lapTimesJson = '{{ lap_times|escapejs }}';
        console.log('Lap times JSON:', lapTimesJson);
        const lapTimes = JSON.parse(lapTimesJson) || {};
        console.log('Lap times:', lapTimes);

        if (Object.keys(lapTimes).length === 0) {
            console.error('No lap data found for the selected race.');
        } else {
            const requiredCars = Array.from({ length: 65 }, (_, i) => i);
            requiredCars.forEach((carNumber) => {
                if (!(carNumber in lapTimes)) {
                    console.warn(`No lap data found for car number ${carNumber}`);
                }
            });

            const labels = [];
            const datasets = [];

            // Assuming that lapTimes has the same number of laps for each car
            const firstCarNumber = Object.keys(lapTimes)[0];
            const numberOfLaps = lapTimes[firstCarNumber].length;

            for (let i = 0; i < numberOfLaps; i++) {
                labels.push(`Lap ${i + 1}`);
            }

            for (const carNumber in lapTimes) {
                const carLapTimes = lapTimes[carNumber];
                const carDataset = {
                    label: `Car ${carNumber}`,
                    data: carLapTimes,
                    borderColor: `hsl(${Math.random() * 360}, 100%, 50%)`,
                    borderWidth: 1,
                    fill: false,
                };
                datasets.push(carDataset);
            }

            const chart = new Chart(document.getElementById('lapTimeChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    });

    </script>
</body>
</html>